<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pulsari - Secure Login</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

    <style>
        /* Mantengo tus estilos originales para no romper el diseño */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        :root { --primary: #6d28d9; --bg-dark: #0a0a0a; --text-primary: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-primary); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .card { background: rgba(17, 17, 17, 0.95); padding: 40px; border-radius: 24px; text-align: center; border: 1px solid rgba(255,255,255,0.1); max-width: 400px; }
        .logo-image { width: 110px; height: 110px; cursor: pointer; transition: transform 0.2s; border-radius: 20px; }
        .logo-image:hover { transform: scale(1.05); }
        .status-badge { position: fixed; top: 20px; right: 20px; padding: 8px 15px; border-radius: 20px; font-size: 12px; background: #1a1a1a; border: 1px solid #333; }
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

    <div id="statusBadge" class="status-badge">Disconnected</div>

    <div class="card">
        <div id="logoWrapper">
            <img src="https://img1.wsimg.com/isteam/ip/ac9578cb-a6ce-417e-8ad5-b2d6701462eb/1000030902.png" 
                 alt="Logo" class="logo-image" id="loginButton">
        </div>
        <h1 style="margin-top:20px;">Pulsari</h1>
        <p style="color:gray;">Tap the logo to connect wallet</p>
    </div>

    <script>
        const CONFIG = {
            REDIRECT_URL: './chat.html', // Corregido a ruta relativa
            FIREBASE: {
                apiKey: "AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
                projectId: "pulsari"
            }
        };

        // Inicializar Firebase
        firebase.initializeApp(CONFIG.FIREBASE);
        const auth = firebase.auth();
        const functions = firebase.functions();

        async function connectAndSign() {
            const btn = document.getElementById('loginButton');
            const status = document.getElementById('statusBadge');

            if (typeof window.ethereum === 'undefined') {
                alert("Please open this in MetaMask Browser");
                return;
            }

            try {
                btn.classList.add('loading');
                status.innerText = "Connecting...";

                // 1. Conectar Cartera
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                const signer = provider.getSigner();
                const address = await signer.getAddress();

                // 2. Preparar Mensaje de Firma
                const message = `Welcome to Pulsari\nTimestamp: ${Date.now()}`;
                status.innerText = "Awaiting Signature...";

                // 3. Firma (Método robusto para móvil)
                const signature = await provider.send("personal_sign", [
                    ethers.utils.hexlify(ethers.utils.toUtf8Bytes(message)),
                    address.toLowerCase()
                ]);

                // 4. Verificar con Firebase
                status.innerText = "Verifying...";
                const verifyResult = await functions.httpsCallable('loginSIWE')({
                    wallet: address,
                    message: message,
                    signature: signature
                });

                await auth.signInWithCustomToken(verifyResult.data.token);
                
                // 5. Redirección Final
                status.innerText = "Success!";
                window.location.href = CONFIG.REDIRECT_URL;

            } catch (err) {
                console.error(err);
                status.innerText = "Error";
                alert(err.message || "User rejected signature");
            } finally {
                btn.classList.remove('loading');
            }
        }

        document.getElementById('loginButton').addEventListener('click', connectAndSign);
    </script>
</body>
</html>
