<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MuzzSnap | Web3 Social</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Orbitron:wght@700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: #e5e5e5; overflow-x: hidden; margin: 0; }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        .bg-glow { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; height: 600px; background: radial-gradient(circle, rgba(185, 28, 28, 0.1) 0%, transparent 70%); z-index: -1; pointer-events: none; }
        .glass-card { background: rgba(23, 23, 23, 0.7); border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(12px); }
        .hidden-section { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #logoButton { cursor: pointer; transition: all 0.3s ease; }
        #logoButton:hover { transform: scale(1.05); filter: drop-shadow(0 0 15px rgba(220,38,38,0.3)); }
        .spinner { border: 3px solid rgba(220, 38, 38, 0.1); border-top-color: #dc2626; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .badge-verified { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); }
    </style>
</head>
<body>
    <div class="bg-glow"></div>

    <!-- LOGIN VIEW -->
    <section id="loginView" class="flex flex-col items-center justify-center min-h-screen max-w-sm mx-auto text-center px-4">
        <div id="logoButton" class="mb-6 relative group">
            <img src="https://img1.wsimg.com/isteam/ip/ac9578cb-a6ce-417e-8ad5-b2d6701462eb/1000030902.png" 
                 alt="MuzzSnap" class="w-40 h-40 rounded-2xl shadow-2xl">
            <div id="loadingSpinner" class="hidden absolute inset-0 flex items-center justify-center bg-black/40 rounded-2xl backdrop-blur-sm">
                <div class="spinner"></div>
            </div>
        </div>

        <h1 class="orbitron text-2xl font-black mb-2 tracking-tighter text-white">MUZZSNAP</h1>
        <p class="text-[10px] text-gray-500 mb-8 tracking-widest uppercase leading-relaxed">
            Secure Decentralized Social Network<br>Âçò„Å™„Çã„Ç¢„Éó„É™‰ª•‰∏ä„ÅÆ„ÇÇ„ÅÆ
        </p>

        <div id="messageArea" class="hidden w-full mb-6 p-4 bg-red-900/10 border border-red-900/20 rounded-xl">
            <p id="messageTitle" class="text-xs font-bold text-red-500 mb-1"></p>
            <p id="messageText" class="text-[10px] text-gray-400 font-mono whitespace-pre-line"></p>
        </div>

        <p class="text-[10px] text-gray-600 animate-pulse">
            Click logo to connect wallet<br>„É≠„Ç¥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Êé•Á∂ö
        </p>

        <!-- Bot√≥n alternativo para testing sin wallet -->
        <button id="guestMode" class="mt-4 text-[9px] text-gray-700 hover:text-gray-500 transition underline">
            Enter as guest (testing mode)
        </button>
    </section>

    <!-- APP VIEW -->
    <section id="appView" class="hidden-section fade-in">
        <header class="sticky top-0 z-50 bg-[#0a0a0a]/80 border-b border-white/10 backdrop-blur-xl">
            <div class="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <img src="https://img1.wsimg.com/isteam/ip/ac9578cb-a6ce-417e-8ad5-b2d6701462eb/1000030902.png" class="w-8 h-8 rounded-md">
                    <span class="orbitron text-md tracking-tighter text-white">MUZZSNAP</span>
                </div>
                <div class="flex items-center gap-3">
                    <div id="walletBadge" class="hidden text-[10px] font-mono badge-verified text-white px-3 py-1 rounded-full"></div>
                    <div id="userBadge" class="text-[10px] font-mono bg-red-600/10 text-red-500 border border-red-500/20 px-3 py-1 rounded-full"></div>
                    <button id="logoutBtn" class="text-[10px] text-gray-500 hover:text-red-500 transition">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-2xl mx-auto px-4 py-8 space-y-6">
            <!-- Composer -->
            <div class="glass-card rounded-2xl p-5 border-l-2 border-red-600">
                <div class="flex gap-4">
                    <div id="myAvatar" class="w-10 h-10 rounded-full bg-red-900/20 flex items-center justify-center text-[10px] font-bold text-red-500 border border-red-500/20 flex-shrink-0"></div>
                    <div class="flex-1">
                        <textarea id="postContent" placeholder="¬øQu√© est√°s pensando?" 
                            class="w-full bg-transparent border-none focus:outline-none text-white text-md resize-none h-20 placeholder:text-gray-700"></textarea>
                        <div class="flex justify-between items-center pt-3 border-t border-white/5">
                            <div class="flex gap-2 text-gray-600">
                                <button class="hover:text-red-500 transition"><i class="fas fa-image"></i></button>
                                <button class="hover:text-red-500 transition"><i class="fas fa-smile"></i></button>
                                <button class="hover:text-red-500 transition"><i class="fas fa-hashtag"></i></button>
                            </div>
                            <button id="btnPost" class="bg-red-600 px-6 py-2 rounded-full text-xs font-black text-white hover:bg-red-700 hover:scale-105 transition-all">
                                POST
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feed -->
            <div id="feed" class="space-y-4 pb-20"></div>
            
            <!-- Loading indicator -->
            <div id="feedLoading" class="text-center py-8">
                <div class="spinner mx-auto mb-2"></div>
                <p class="text-[10px] text-gray-600">Loading posts...</p>
            </div>
        </main>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, updateDoc, doc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDAKdLm7lf32hPPJJ_pyr1Wxj_dYgLnviY",
            authDomain: "connect-74a76.firebaseapp.com",
            projectId: "connect-74a76",
            storageBucket: "connect-74a76.firebasestorage.app",
            messagingSenderId: "126156115472",
            appId: "1:126156115472:web:8c1131ea34c9069b4dc495",
            measurementId: "G-XCDK0R2NET"
        };

        console.log("üî• Initializing Firebase...");
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const postsCol = collection(db, "posts");
        console.log("‚úÖ Firebase connected");

        let userWallet = "";
        let isGuest = false;

        // Detectar proveedor de wallet (MetaMask, Trust, Coinbase, etc)
        function getProvider() {
            if (window.ethereum) return window.ethereum;
            if (window.web3?.currentProvider) return window.web3.currentProvider;
            return null;
        }

        // Login con Wallet
        async function handleWalletLogin() {
            console.log("üîê Starting wallet connection...");
            
            const provider = getProvider();
            
            if (!provider) {
                console.log("‚ùå No wallet detected");
                showMessage("WALLET NO DETECTADA", 
                    "No se detect√≥ ninguna wallet.\n\n" +
                    "Opciones:\n" +
                    "‚Ä¢ Instala MetaMask, Trust Wallet o Coinbase Wallet\n" +
                    "‚Ä¢ En m√≥vil: Abre esta p√°gina desde el navegador de tu wallet\n" +
                    "‚Ä¢ O usa el modo invitado para testing"
                );
                return false;
            }

            const spinner = document.getElementById('loadingSpinner');
            const msgArea = document.getElementById('messageArea');
            spinner.classList.remove('hidden');
            msgArea.classList.add('hidden');

            try {
                console.log("ü¶ä Requesting accounts...");
                
                // Solicitar conexi√≥n - compatible con todos los wallets
                const accounts = await provider.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                if (!accounts || accounts.length === 0) {
                    throw new Error("No se pudo obtener la cuenta");
                }
                
                userWallet = accounts[0];
                console.log("‚úÖ Wallet connected:", userWallet);

                // Obtener red (opcional, no bloquea)
                try {
                    const chainId = await provider.request({ method: 'eth_chainId' });
                    console.log("üåê Network:", chainId);
                } catch (e) {
                    console.log("‚ö†Ô∏è Could not get network info");
                }

                return true;

            } catch (error) {
                console.error("‚ùå Connection error:", error);
                
                if (error.code === 4001) {
                    showMessage("CONEXI√ìN RECHAZADA", "Has rechazado la conexi√≥n de la wallet.");
                } else if (error.code === -32002) {
                    showMessage("SOLICITUD PENDIENTE", "Ya hay una solicitud de conexi√≥n pendiente. Revisa tu wallet.");
                } else {
                    showMessage("ERROR DE CONEXI√ìN", error.message || "No se pudo conectar la wallet");
                }
                return false;

            } finally {
                spinner.classList.add('hidden');
            }
        }

        // Entrar a la app
        function enterApp(wallet, guest = false) {
            isGuest = guest;
            userWallet = wallet;
            
            document.getElementById('loginView').classList.add('hidden-section');
            document.getElementById('appView').classList.remove('hidden-section');
            
            const nick = wallet.slice(-6).toUpperCase();
            document.getElementById('userBadge').innerText = guest ? "GUEST" : `...${nick}`;
            document.getElementById('myAvatar').innerText = guest ? "GT" : nick.substring(0,2);
            
            if (!guest) {
                const walletBadge = document.getElementById('walletBadge');
                walletBadge.innerText = `üîí VERIFIED`;
                walletBadge.classList.remove('hidden');
            }
            
            initFeed();
            console.log("üéâ App initialized");
        }

        // Mostrar mensajes
        function showMessage(title, text) {
            const msgArea = document.getElementById('messageArea');
            document.getElementById('messageTitle').innerText = title;
            document.getElementById('messageText').innerText = text;
            msgArea.classList.remove('hidden');
        }

        // Click en logo - Conectar wallet
        document.getElementById('logoButton').onclick = async () => {
            const connected = await handleWalletLogin();
            if (connected) {
                enterApp(userWallet, false);
            }
        };

        // Modo invitado
        document.getElementById('guestMode').onclick = () => {
            const guestId = 'GUEST_' + Math.random().toString(36).substr(2, 9);
            enterApp(guestId, true);
        };

        // Logout
        document.getElementById('logoutBtn').onclick = () => {
            location.reload();
        };

        // Inicializar Feed
        function initFeed() {
            console.log("üì∞ Loading feed...");
            const q = query(postsCol, orderBy("timestamp", "desc"), limit(50));
            
            onSnapshot(q, (snap) => {
                console.log(`üìù ${snap.size} posts loaded`);
                const feed = document.getElementById('feed');
                const loading = document.getElementById('feedLoading');
                
                feed.innerHTML = "";
                loading.classList.add('hidden');
                
                if (snap.empty) {
                    feed.innerHTML = `
                        <div class="text-center py-12 text-gray-600">
                            <i class="fas fa-inbox text-4xl mb-3 opacity-20"></i>
                            <p class="text-sm">No hay posts a√∫n</p>
                            <p class="text-xs mt-1">¬°S√© el primero en publicar!</p>
                        </div>
                    `;
                    return;
                }
                
                snap.forEach((post) => {
                    const d = post.data();
                    const nick = d.author ? d.author.slice(-6).toUpperCase() : "ANON";
                    const isVerified = d.author && d.author.startsWith('0x');
                    
                    const article = document.createElement('article');
                    article.className = 'glass-card rounded-2xl p-5 hover:border-white/10 transition';
                    article.innerHTML = `
                        <div class="flex gap-4">
                            <div class="w-10 h-10 rounded-full bg-red-600/10 flex items-center justify-center text-[10px] font-bold text-red-500 border border-red-500/20 flex-shrink-0">
                                ${nick.substring(0,2)}
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <span class="text-xs font-bold text-white">@${nick}</span>
                                        ${isVerified ? '<i class="fas fa-check-circle text-red-500 text-[8px] ml-1"></i>' : ''}
                                    </div>
                                    <span class="text-[9px] text-gray-600">
                                        ${d.timestamp ? new Date(d.timestamp.toDate()).toLocaleDateString() : 'Ahora'}
                                    </span>
                                </div>
                                <p class="text-gray-300 text-sm leading-relaxed mb-3">${escapeHtml(d.content)}</p>
                                <div class="flex items-center gap-6 text-gray-600">
                                    <button onclick="socialAction('${post.id}', 'likes')" 
                                        class="flex items-center gap-1 hover:text-red-500 transition group">
                                        <i class="far fa-heart group-hover:fas"></i>
                                        <span class="text-[10px]">${d.likes || 0}</span>
                                    </button>
                                    <button onclick="socialAction('${post.id}', 'retweets')" 
                                        class="flex items-center gap-1 hover:text-green-500 transition group">
                                        <i class="fas fa-retweet"></i>
                                        <span class="text-[10px]">${d.retweets || 0}</span>
                                    </button>
                                    <button class="flex items-center gap-1 hover:text-blue-500 transition">
                                        <i class="far fa-comment"></i>
                                        <span class="text-[10px]">${d.comments || 0}</span>
                                    </button>
                                    <button class="flex items-center gap-1 hover:text-purple-500 transition">
                                        <i class="fas fa-share"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    feed.appendChild(article);
                });
            }, (error) => {
                console.error("‚ùå Feed error:", error);
                document.getElementById('feedLoading').innerHTML = `
                    <p class="text-red-500 text-xs">Error al cargar el feed</p>
                `;
            });
        }

        // Publicar post
        document.getElementById('btnPost').onclick = async () => {
            const content = document.getElementById('postContent').value.trim();
            const btn = document.getElementById('btnPost');
            
            if(!content) {
                alert("Escribe algo para publicar");
                return;
            }

            if (content.length > 500) {
                alert("El post no puede exceder 500 caracteres");
                return;
            }
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                console.log("üì§ Publishing post...");
                await addDoc(postsCol, {
                    content,
                    author: userWallet,
                    timestamp: serverTimestamp(),
                    likes: 0,
                    retweets: 0,
                    comments: 0
                });
                
                document.getElementById('postContent').value = "";
                console.log("‚úÖ Post published");
                
            } catch (error) {
                console.error("‚ùå Publish error:", error);
                alert("Error al publicar. Intenta de nuevo.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'POST';
            }
        };

        // Acciones sociales
        window.socialAction = async (id, field) => {
            try {
                console.log(`üëç Updating ${field} for ${id}`);
                const ref = doc(db, "posts", id);
                await updateDoc(ref, { [field]: increment(1) });
            } catch (error) {
                console.error("‚ùå Social action error:", error);
            }
        };

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Detectar cambios de cuenta
        if (getProvider()) {
            getProvider().on('accountsChanged', (accounts) => {
                console.log("üîÑ Account changed");
                if (accounts.length === 0 || !isGuest) {
                    location.reload();
                }
            });
            
            getProvider().on('chainChanged', () => {
                console.log("üîÑ Network changed");
                location.reload();
            });
        }

        console.log("üöÄ MuzzSnap ready!");
    </script>
</body>
</html>
