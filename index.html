<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pulsari Secure Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<script src="https://unpkg.com/@walletconnect/ethereum-provider@2.11.1/dist/index.umd.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

<style>
body{background:#000;color:#fff;font-family:Arial;display:flex;align-items:center;justify-content:center;height:100vh}
.box{background:#111;padding:30px;border-radius:14px;width:340px;text-align:center}
button{width:100%;padding:14px;background:#6d28d9;border:none;border-radius:8px;color:#fff;font-size:16px}
#status{margin-top:12px;font-size:14px}
</style>
</head>

<body>
<div class="box">
<h2>Pulsari Access</h2>
<button onclick="login()">Connect Wallet</button>
<div id="status"></div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
  projectId: "pulsari"
});
const auth = firebase.auth();
const functions = firebase.functions();

const WC_PROJECT_ID = "cbb8c131e6f916a235b0825e181ab0c9";

async function login() {
  try {
    set("Connecting wallet…");

    let provider;
    if (window.ethereum) {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
    } else {
      const wc = await WalletConnectEthereumProvider.init({
        projectId: WC_PROJECT_ID,
        chains:[1]
      });
      await wc.enable();
      provider = new ethers.providers.Web3Provider(wc);
    }

    const signer = provider.getSigner();
    const wallet = await signer.getAddress();

    const nonce = Math.random().toString(36).substring(2);
    const message =
`pulsari.app wants you to sign in with your Ethereum account:
${wallet}

URI: https://pulsari.app
Version: 1
Chain ID: 1
Nonce: ${nonce}
Issued At: ${new Date().toISOString()}`;

    set("Signing message…");
    const signature = await signer.signMessage(message);

    const result = await functions.httpsCallable("loginSIWE")({
      wallet, message, signature
    });

    await auth.signInWithCustomToken(result.data.token);

    set("Access granted ✔");
    setTimeout(()=>location.href="chat.html",500);

  } catch(e) {
    alert(e.message || e);
    set("Access denied");
  }
}

function set(t){document.getElementById("status").innerText=t}
</script>
</body>
</html>
