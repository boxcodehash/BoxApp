<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pulsari Secure Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ethers -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

<!-- WalletConnect v2 - ACTUALIZADO CON RESPALDO -->
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.15.2/dist/index.umd.js" 
        onerror="loadWalletConnectBackup()"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Arial, sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  padding:20px;
  box-sizing:border-box;
}
.box{
  background:#111;
  padding:30px;
  border-radius:16px;
  width:100%;
  max-width:340px;
  text-align:center;
  box-shadow:0 8px 32px rgba(109,40,217,0.3);
}
h2{
  margin-top:0;
  color:#a78bfa;
}
button{
  width:100%;
  padding:15px;
  margin-top:16px;
  background:#6d28d9;
  border:none;
  border-radius:10px;
  font-size:16px;
  color:#fff;
  cursor:pointer;
  transition:all 0.3s;
  font-weight:600;
}
button:hover:not(:disabled){
  background:#7c3aed;
  transform:translateY(-2px);
}
button:disabled{
  opacity:0.5;
  cursor:not-allowed;
}
#status{
  margin-top:14px;
  min-height:18px;
  font-size:14px;
  color:#a78bfa;
}
.small{
  font-size:12px;
  opacity:.6;
  margin-top:12px;
  line-height:1.6;
}
.loading{
  display:inline-block;
  animation:pulse 1.5s ease-in-out infinite;
}
@keyframes pulse{
  0%, 100%{opacity:1;}
  50%{opacity:0.5;}
}
</style>
</head>

<body>
<div class="box">
  <h2>üîê Pulsari Access</h2>

  <button id="connectBtn" onclick="connectWallet()">Connect Wallet</button>

  <div id="status"></div>

  <div class="small">
    Mobile & Desktop Compatible<br>
    MetaMask ¬∑ Crypto ¬∑ Trust ¬∑ OKX ¬∑ Rainbow
  </div>
</div>

<script>
/* =========================
   üîÑ CDN RESPALDO
========================= */
function loadWalletConnectBackup() {
  console.log('Loading WalletConnect from backup CDN...');
  const script = document.createElement('script');
  script.src = 'https://unpkg.com/@walletconnect/ethereum-provider@2.15.2/dist/index.umd.js';
  script.onerror = () => {
    console.error('Both WalletConnect CDNs failed');
    alert('Failed to load WalletConnect library. Please check your internet connection.');
  };
  document.head.appendChild(script);
}

/* =========================
   ‚è≥ VERIFICAR CARGA
========================= */
let librariesLoaded = false;

window.addEventListener('load', function() {
  setTimeout(() => {
    librariesLoaded = true;
    console.log('Libraries status:', {
      ethers: typeof ethers !== 'undefined',
      walletConnect: typeof window.WalletConnectProvider !== 'undefined',
      firebase: typeof firebase !== 'undefined'
    });
  }, 1000);
});

/* =========================
   üî• FIREBASE CONFIG
========================= */
firebase.initializeApp({
  apiKey: "AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
  projectId: "pulsari"
});

const auth = firebase.auth();
const functions = firebase.functions();

/* =========================
   üîó WALLETCONNECT CONFIG
========================= */
const WC_PROJECT_ID = "cbb8c131e6f916a235b0825e181ab0c9";

/* =========================
   üîç MOBILE DETECTION
========================= */
function isMobile() {
  return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

/* =========================
   üöÄ CONNECT WALLET
========================= */
async function connectWallet() {
  const btn = document.getElementById('connectBtn');
  
  try {
    btn.disabled = true;
    setStatus("üîó Connecting wallet...", true);

    // Verificar que las librer√≠as est√©n cargadas
    if (!librariesLoaded) {
      setStatus("‚è≥ Loading libraries...", true);
      await new Promise(resolve => setTimeout(resolve, 1500));
    }

    if (typeof ethers === 'undefined') {
      throw new Error("Ethers library not loaded. Please refresh the page.");
    }

    let provider;

    // ‚úÖ Desktop (MetaMask injected)
    if (window.ethereum && !isMobile()) {
      console.log('Using MetaMask/Injected provider');
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      await provider.send("eth_requestAccounts", []);
    } 
    // ‚úÖ Mobile (WalletConnect)
    else {
      console.log('Using WalletConnect for mobile');
      
      // Verificar que WalletConnect est√© disponible
      if (typeof window.WalletConnectProvider === 'undefined') {
        throw new Error("WalletConnect library not loaded. Please refresh the page and try again.");
      }

      setStatus("üîó Initializing WalletConnect...", true);

      const EthereumProvider = window.WalletConnectProvider.default || window.WalletConnectProvider;
      
      const wc = await EthereumProvider.init({
        projectId: WC_PROJECT_ID,
        chains: [1],
        showQrModal: true,
        metadata: {
          name: "Pulsari",
          description: "Secure Web3 Access Platform",
          url: "https://pulsari.app",
          icons: ["https://avatars.githubusercontent.com/u/37784886"]
        }
      });

      setStatus("üì± Opening wallet app...", true);
      await wc.enable();
      
      provider = new ethers.providers.Web3Provider(wc, "any");
    }

    await loginSIWE(provider);

  } catch (err) {
    console.error('Connection error:', err);
    const errorMsg = err.message || err.toString();
    setStatus("‚ùå Error: " + errorMsg);
    
    if (errorMsg.includes('User rejected')) {
      alert("Connection cancelled by user");
    } else if (errorMsg.includes('not loaded')) {
      alert(errorMsg + "\n\nPlease refresh the page and try again.");
    } else {
      alert("Connection failed: " + errorMsg);
    }
  } finally {
    btn.disabled = false;
  }
}

/* =========================
   üîê SIWE LOGIN
========================= */
async function loginSIWE(provider) {
  try {
    const signer = provider.getSigner();
    const wallet = await signer.getAddress();
    
    console.log('Connected wallet:', wallet);
    
    const nonce = Math.random().toString(36).substring(2);
    const timestamp = new Date().toISOString();

    const message = `pulsari.app wants you to sign in with your Ethereum account:
${wallet}

URI: https://pulsari.app
Version: 1
Chain ID: 1
Nonce: ${nonce}
Issued At: ${timestamp}`;

    setStatus("‚úçÔ∏è Please sign the message...", true);

    const signature = await signer.signMessage(message);

    setStatus("üîç Verifying signature...", true);

    const result = await functions.httpsCallable("loginSIWE")({
      wallet,
      message,
      signature
    });

    await auth.signInWithCustomToken(result.data.token);

    setStatus("‚úÖ Access granted!");

    setTimeout(() => {
      window.location.href = "chat.html";
    }, 800);

  } catch (err) {
    console.error('SIWE error:', err);
    throw new Error('Authentication failed: ' + (err.message || err));
  }
}

/* =========================
   üìä STATUS HELPER
========================= */
function setStatus(text, isLoading = false) {
  const statusEl = document.getElementById("status");
  statusEl.innerHTML = isLoading ? `<span class="loading">${text}</span>` : text;
}
</script>
</body>
</html>
