<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MuzzSnap – 3D Web3 Chat</title>

<!-- React -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- UI -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@400;600;700&display=swap');

:root{
  --accent:#ff0000;
  --accent-glow:rgba(255,0,0,.6);
  --glass-bg:rgba(20,0,0,.45);
  --glass-border:rgba(255,0,0,.25);
}

*{margin:0;padding:0;box-sizing:border-box}
body{
  background:black;
  color:white;
  font-family:'Rajdhani',sans-serif;
  height:100vh;
  overflow:hidden;
}

/* Fondo */
.cyber-grid{
  position:fixed;inset:0;
  background:
    radial-gradient(circle at top,var(--accent-glow),transparent 50%),
    radial-gradient(circle at bottom,var(--accent-glow),transparent 50%);
  z-index:-1;
}

/* ===== CHAT 3D ===== */
.chat-3d-stage{
  perspective:1400px;
}
.chat-3d-card{
  background:var(--glass-bg);
  backdrop-filter:blur(30px) saturate(180%);
  border-radius:30px;
  border:1px solid var(--glass-border);
  transform-style:preserve-3d;
  box-shadow:
    0 40px 120px rgba(0,0,0,.9),
    inset 0 1px 0 rgba(255,255,255,.15),
    0 0 90px var(--accent-glow);
  transition:transform .2s ease;
  position:relative;
}
.chat-3d-card::before{
  content:'';
  position:absolute;
  inset:-3px;
  border-radius:inherit;
  background:linear-gradient(120deg,transparent,var(--accent),transparent);
  opacity:.18;
  filter:blur(25px);
}
.chat-3d-layer{transform:translateZ(45px)}

.message-bubble{
  padding:14px 20px;
  border-radius:18px;
  max-width:75%;
  transform-style:preserve-3d;
  animation:pop .3s ease;
}
@keyframes pop{
  from{opacity:0;transform:scale(.8) translateY(10px)}
  to{opacity:1;transform:scale(1)}
}
.message-bubble.me{
  background:linear-gradient(135deg,var(--accent),black);
  transform:translateZ(30px);
}
.message-bubble.other{
  background:rgba(40,40,40,.8);
  border:1px solid rgba(255,255,255,.1);
  transform:translateZ(18px);
}

.input-3d{
  background:var(--glass-bg);
  border:1px solid var(--glass-border);
  border-radius:20px;
  padding:16px;
  color:white;
  width:100%;
}

.send-btn{
  width:60px;height:60px;
  border-radius:18px;
  background:linear-gradient(135deg,var(--accent),black);
  color:white;font-size:22px;
  box-shadow:0 0 25px var(--accent-glow);
}
</style>
</head>

<body>
<div class="cyber-grid"></div>
<div id="root"></div>

<script type="text/babel">
const {useState,useEffect,useRef}=React;

/* Firebase */
firebase.initializeApp({
  apiKey:"AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
  authDomain:"pulsari.firebaseapp.com",
  databaseURL:"https://pulsari-default-rtdb.firebaseio.com",
  projectId:"pulsari"
});
const db=firebase.database();
const auth=firebase.auth();

function App(){
  const [user,setUser]=useState(null);
  const [text,setText]=useState("");
  const [messages,setMessages]=useState([]);
  const scrollRef=useRef();

  /* LOGIN AUTOMÁTICO WALLET */
  const login=async()=>{
    if(!window.ethereum){
      alert("MetaMask requerido");
      return;
    }
    const accs=await window.ethereum.request({method:'eth_requestAccounts'});
    const wallet=accs[0].toLowerCase();

    const hash=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(wallet));
    const id=[...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join('');

    const cred=await auth.signInAnonymously();
    const u={uid:cred.user.uid,name:"Anon_"+wallet.slice(-4),wallet};
    await db.ref("presence/"+u.uid).set(u);
    db.ref("presence/"+u.uid).onDisconnect().remove();
    setUser(u);
  };

  useEffect(()=>{ login(); },[]);

  useEffect(()=>{
    if(!user) return;
    db.ref("messages/general").limitToLast(50).on("value",s=>{
      const v=s.val()||{};
      setMessages(Object.keys(v).map(k=>({id:k,...v[k]})));
    });
  },[user]);

  useEffect(()=>{scrollRef.current?.scrollIntoView({behavior:"smooth"})},[messages]);

  /* Tilt 3D */
  useEffect(()=>{
    const card=document.querySelector(".chat-3d-card");
    if(!card) return;
    const move=e=>{
      const r=card.getBoundingClientRect();
      const x=((e.clientX||e.touches?.[0]?.clientX)-r.left)/r.width-.5;
      const y=((e.clientY||e.touches?.[0]?.clientY)-r.top)/r.height-.5;
      card.style.transform=`rotateY(${x*12}deg) rotateX(${-y*12}deg)`;
    };
    const reset=()=>card.style.transform="rotateX(0) rotateY(0)";
    card.addEventListener("mousemove",move);
    card.addEventListener("mouseleave",reset);
    return()=>card.removeEventListener("mousemove",move);
  },[user]);

  const send=async()=>{
    if(!text.trim()) return;
    await db.ref("messages/general").push({
      content:text,
      uid:user.uid,
      time:Date.now()
    });
    setText("");
  };

  if(!user){
    return(
      <div className="h-screen flex items-center justify-center">
        <div className="text-center">
          <h1 className="text-4xl font-black mb-4">MUZZSNAP</h1>
          <p className="opacity-60">Firmando wallet…</p>
        </div>
      </div>
    );
  }

  return(
    <div className="h-screen flex flex-col chat-3d-stage p-4">
      <div className="chat-3d-card flex-1 p-6 max-w-5xl mx-auto w-full">
        <div className="chat-3d-layer space-y-4 overflow-y-auto h-full">
          {messages.map(m=>(
            <div key={m.id} className={m.uid===user.uid?"flex justify-end":"flex"}>
              <div className={"message-bubble "+(m.uid===user.uid?"me":"other")}>
                {m.content}
              </div>
            </div>
          ))}
          <div ref={scrollRef}></div>
        </div>
      </div>

      <div className="flex gap-3 max-w-5xl mx-auto w-full mt-4">
        <input className="input-3d"
          value={text}
          onChange={e=>setText(e.target.value)}
          onKeyDown={e=>e.key==="Enter"&&send()}
          placeholder="Transmitiendo…"
        />
        <button onClick={send} className="send-btn">
          <i className="fas fa-bolt"></i>
        </button>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
