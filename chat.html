<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MuzzSnap - Multi-Theme Enterprise</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    /* TEMA CLARO (Corporativo) */
    .theme-light {
      --bg-main: #f8fafc;
      --bg-card: #ffffff;
      --bg-sidebar: #0f172a;
      --text-main: #1e293b; /* Azul marino profundo */
      --text-muted: #64748b;
      --primary: #e11d48; /* Rojo Rose profesional */
      --border: #e2e8f0;
      --bubble-me: #e11d48;
      --bubble-other: #ffffff;
      --text-bubble-me: #ffffff;
    }

    /* TEMA OSCURO (Táctico) */
    .theme-dark {
      --bg-main: #000000;
      --bg-card: #0a0a0a;
      --bg-sidebar: #050505;
      --text-main: #ff3131; /* Letras Rojas */
      --text-muted: #880000;
      --primary: #ff0000;
      --border: #330000;
      --bubble-me: #ff0000;
      --bubble-other: #111111;
      --text-bubble-me: #ffffff;
    }

    body { 
      font-family: 'Inter', sans-serif; 
      margin: 0; 
      transition: all 0.3s ease;
      background-color: var(--bg-main);
      color: var(--text-main);
    }

    .app-shell { background-color: var(--bg-main); }
    .sidebar { background-color: var(--bg-sidebar); border-right: 1px solid var(--border); }
    .main-content { background-color: var(--bg-card); border-left: 1px solid var(--border); }
    
    .bubble-pro { 
      padding: 12px 16px; border-radius: 14px; font-size: 14px; 
      transition: all 0.2s;
    }
    .bubble-pro.me { 
      background-color: var(--bubble-me); color: var(--text-bubble-me); 
      border-bottom-right-radius: 2px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .bubble-pro.other { 
      background-color: var(--bubble-other); color: var(--text-main); 
      border: 1px solid var(--border); border-bottom-left-radius: 2px; 
    }

    .notification-toast {
      position: fixed; top: 20px; right: 20px; z-index: 100;
      background: var(--bg-card); border-left: 4px solid var(--primary);
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
      color: var(--text-main);
    }
  </style>
</head>
<body class="theme-light" id="body-theme">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Configuración Firebase (Misma que antes)
    const firebaseConfig = {
      apiKey: "AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
      authDomain: "pulsari.firebaseapp.com",
      databaseURL: "https://pulsari-default-rtdb.firebaseio.com",
      projectId: "pulsari",
      databaseURL: "https://pulsari-default-rtdb.firebaseio.com",
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const RYACHU_WALLET = "0x208157b5ec396759e8754058108ecf53e32392ff".toLowerCase();

    function App() {
      const [user, setUser] = useState(null);
      const [theme, setTheme] = useState('light'); // 'light' o 'dark'
      const [messages, setMessages] = useState([]);
      const [inputText, setInputText] = useState("");
      const [typingUsers, setTypingUsers] = useState([]);
      const [alert, setAlert] = useState(null);
      const dummyRef = useRef(null);

      // Cambiar clase del body cuando cambie el tema
      useEffect(() => {
        document.getElementById('body-theme').className = theme === 'light' ? 'theme-light' : 'theme-dark';
      }, [theme]);

      useEffect(() => {
        const wallet = sessionStorage.getItem('muzz_wallet_address');
        if (!wallet) { window.location.href = 'index.html'; return; }
        
        firebase.auth().signInAnonymously().then(cred => {
          const userData = {
            uid: cred.user.uid,
            username: wallet.toLowerCase() === RYACHU_WALLET ? "Ryachu" : `User_${wallet.slice(-4)}`,
            address: wallet
          };
          setUser(userData);
          database.ref(`presence/${cred.user.uid}`).set({...userData, online: true});
        });

        // Listeners de Firebase
        const msgRef = database.ref('messages/general').limitToLast(50);
        msgRef.on('value', snap => {
          const data = snap.val();
          setMessages(data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : []);
        });

        database.ref('typing/general').on('value', snap => {
          const data = snap.val() || {};
          setTypingUsers(Object.keys(data).filter(id => id !== user?.uid).map(id => data[id].name));
        });

        return () => { msgRef.off(); database.ref('typing/general').off(); };
      }, [user?.uid]);

      useEffect(() => { dummyRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

      const handleSend = () => {
        if (!inputText.trim()) return;
        database.ref('messages/general').push({
          content: inputText, userId: user.uid, username: user.username,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        setInputText("");
        database.ref(`typing/general/${user.uid}`).remove();
      };

      if (!user) return <div className="h-screen flex items-center justify-center bg-white"><div className="animate-spin rounded-full h-12 w-12 border-t-2 border-rose-600"></div></div>;

      return (
        <div className="flex h-screen app-shell p-0 lg:p-4 overflow-hidden">
          {alert && <div className="notification-toast p-4 rounded-lg flex items-center gap-3 w-80">...</div>}

          <div className="flex w-full max-w-7xl mx-auto rounded-none lg:rounded-3xl shadow-2xl overflow-hidden border border-[var(--border)]">
            
            {/* SIDEBAR */}
            <aside className="w-20 lg:w-64 sidebar flex flex-col p-4 lg:p-6 transition-all">
              <div className="flex items-center gap-3 mb-10 px-2">
                <div className="w-10 h-10 bg-rose-600 rounded-xl flex items-center justify-center shadow-lg">
                  <i className="fas fa-shield-halved text-white"></i>
                </div>
                <h1 className="hidden lg:block font-bold text-white text-xl">MuzzSnap</h1>
              </div>

              <div className="flex-1 space-y-4">
                <div className="text-[10px] font-bold text-slate-500 uppercase tracking-widest px-2">Workspace</div>
                <button className="w-full flex items-center gap-3 px-3 py-2 rounded-xl bg-white/10 text-white text-sm">
                  <i className="fas fa-hashtag text-rose-500"></i> <span className="hidden lg:block">General</span>
                </button>
              </div>

              {/* TEMA SWITCHER - BOTÓN LLAMATIVO */}
              <div className="mt-auto">
                <button 
                  onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')}
                  className="w-full flex items-center justify-center lg:justify-start gap-3 px-3 py-3 rounded-2xl border border-white/10 hover:bg-white/5 transition-all text-white"
                >
                  <i className={`fas ${theme === 'light' ? 'fa-moon' : 'fa-sun text-amber-400'}`}></i>
                  <span className="hidden lg:block text-xs font-bold uppercase tracking-tighter">
                    {theme === 'light' ? 'Dark Mode' : 'Light Mode'}
                  </span>
                </button>
              </div>
            </aside>

            {/* CHAT AREA */}
            <main className="flex-1 flex flex-col main-content">
              <header className="h-20 border-b border-[var(--border)] flex items-center px-8 justify-between">
                <div>
                  <h2 className="font-bold text-[var(--text-main)] text-sm tracking-widest uppercase">#GENERAL_CHANNEL</h2>
                  <span className="text-[10px] text-emerald-500 font-bold uppercase">● Encrypted Node</span>
                </div>
              </header>

              <div className="flex-1 overflow-y-auto p-6 space-y-6">
                {messages.map(m => (
                  <div key={m.id} className={`flex flex-col ${m.userId === user.uid ? 'items-end' : 'items-start'}`}>
                    <span className="text-[10px] font-bold mb-1 px-1 opacity-50 uppercase tracking-tighter" style={{color: 'var(--text-main)'}}>{m.username}</span>
                    <div className={`bubble-pro ${m.userId === user.uid ? 'me' : 'other'}`}>
                      {m.content}
                    </div>
                  </div>
                ))}
                
                {typingUsers.length > 0 && (
                  <div className="flex items-center gap-2 animate-pulse">
                    <div className="w-1 h-1 bg-[var(--primary)] rounded-full"></div>
                    <span className="text-[10px] italic opacity-60" style={{color: 'var(--text-main)'}}>{typingUsers[0]} is drafting...</span>
                  </div>
                )}
                <div ref={dummyRef}></div>
              </div>

              {/* INPUT AREA */}
              <div className="p-6 border-t border-[var(--border)]">
                <div className="max-w-4xl mx-auto flex items-center gap-4 bg-[var(--bg-main)] p-2 rounded-2xl border border-[var(--border)] focus-within:ring-2 focus-within:ring-rose-500/20 transition-all">
                  <input 
                    value={inputText} 
                    onChange={e => setInputText(e.target.value)}
                    onKeyDown={e => e.key === 'Enter' && handleSend()}
                    placeholder="Type your message..." 
                    className="flex-1 bg-transparent border-none text-sm px-4 focus:ring-0"
                    style={{color: 'var(--text-main)'}}
                  />
                  <button onClick={handleSend} className="w-12 h-12 bg-rose-600 rounded-xl text-white shadow-lg hover:scale-105 transition-transform">
                    <i className="fas fa-paper-plane"></i>
                  </button>
                </div>
              </div>
            </main>
          </div>
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
