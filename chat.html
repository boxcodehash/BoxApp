<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MuzzSnap - Secure Channel</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; overflow: hidden; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #111827; }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 2px; }
  </style>

  <script type="module">
    import { createWeb3Modal, defaultConfig } from 'https://esm.sh/@web3modal/ethers@4.1.11'
    const projectId = '96a7adfe9324271d76ea3a19e400a216'; 
    const mainnet = { chainId: 1, name: 'Ethereum', currency: 'ETH', explorerUrl: 'https://etherscan.io', rpcUrl: 'https://cloudflare-eth.com' }
    const metadata = { name: 'MuzzSnap', description: 'MuzzSnap Secure Chat', url: window.location.origin, icons: ['https://img1.wsimg.com/isteam/ip/ac9578cb-a6ce-417e-8ad5-b2d6701462eb/1000030902.png'] }
    window.web3Modal = createWeb3Modal({ ethersConfig: defaultConfig({ metadata }), chains: [mainnet], projectId, enableAnalytics: true });
  </script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const firebaseConfig = {
      apiKey: "AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
      authDomain: "pulsari.firebaseapp.com",
      databaseURL: "https://pulsari-default-rtdb.firebaseio.com",
      projectId: "pulsari",
      storageBucket: "pulsari.firebasestorage.app",
      messagingSenderId: "824306321233",
      appId: "1:824306321233:web:2c9bfa02170a17d560b570"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    
    const CONTRACT_ADDRESS = "0xef3dAa5fDa8Ad7aabFF4658f1F78061fd626B8f0";
    const MIN_REQUIRED = 40000000;
    const EMOJIS = ['ðŸ˜€','ðŸ˜ƒ','ðŸ˜„','ðŸ˜','ðŸ˜…','ðŸ˜‚','ðŸ˜‰','ðŸ˜Š','ðŸ¥°','ðŸ˜','ðŸ˜˜','ðŸ˜œ','ðŸ˜Ž','ðŸ¥³','ðŸ˜¡','ðŸ˜­','ðŸ‘','ðŸ‘Ž','ðŸ”¥','â¤ï¸'];
    const ERC20_ABI = ["function balanceOf(address owner) view returns (uint256)", "function decimals() view returns (uint8)"];

    // LISTA DE CANALES FIJOS
    const FIXED_CHANNELS = [
        { id: "general", name: "General" },
        { id: "spanish", name: "Spanish" },
        { id: "english", name: "English" },
        { id: "hindi", name: "Hindi" },
        { id: "chinese", name: "Chinese" },
        { id: "crypto", name: "Crypto" },
        { id: "gamers", name: "Gamers" }
    ];

    function App() {
      const [user, setUser] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [statusMsg, setStatusMsg] = useState("Initializing...");
      const [error, setError] = useState(null);
      const [selectedChannel, setSelectedChannel] = useState(FIXED_CHANNELS[0]);
      const [messages, setMessages] = useState([]);
      const [onlineUsers, setOnlineUsers] = useState([]);
      const [inputText, setInputText] = useState("");
      const [showSidebar, setShowSidebar] = useState(window.innerWidth > 1024);
      const [showEmoji, setShowEmoji] = useState(false);
      const dummyRef = useRef(null);

      const authenticateFromSession = async () => {
        const authPending = sessionStorage.getItem('muzz_auth_pending');
        const walletAddress = sessionStorage.getItem('muzz_wallet_address');
        if (authPending === 'true' && walletAddress) {
          try {
            await auth.signInAnonymously();
            const nickname = `User ${walletAddress.slice(0,5)}...${walletAddress.slice(-4)}`;
            setUser({ uid: auth.currentUser.uid, address: walletAddress, nickname: nickname });
            database.ref('users/' + auth.currentUser.uid).update({ username: nickname, wallet: walletAddress, lastSeen: firebase.database.ServerValue.TIMESTAMP });
            sessionStorage.setItem('muzz_auth_pending', 'false');
            setIsLoading(false);
            return true;
          } catch (err) {
            sessionStorage.clear();
            setIsLoading(false);
            return false;
          }
        }
        return false;
      };

      const connectAndLogin = async () => {
        setIsLoading(true);
        try {
            await window.web3Modal.open();
            const checkInterval = setInterval(async () => {
                const p = window.web3Modal.getWalletProvider();
                if(p) { clearInterval(checkInterval); await processLogin(p); }
            }, 1000);
        } catch (e) { setError(e.message); setIsLoading(false); }
      };

      const processLogin = async (walletProvider) => {
        try {
            const ethersProvider = new ethers.providers.Web3Provider(walletProvider);
            const signer = ethersProvider.getSigner();
            const address = await signer.getAddress();
            const contract = new ethers.Contract(CONTRACT_ADDRESS, ERC20_ABI, ethersProvider);
            const balanceBN = await contract.balanceOf(address);
            const decimals = await contract.decimals();
            const balance = parseFloat(ethers.utils.formatUnits(balanceBN, decimals));

            if (balance < MIN_REQUIRED) throw new Error(`Insufficient Balance: ${balance.toFixed(0)} / 40M required`);

            await auth.signInAnonymously();
            const nickname = `User ${address.slice(0,5)}...${address.slice(-4)}`;
            setUser({ uid: auth.currentUser.uid, address: address, nickname: nickname });
            database.ref('users/' + auth.currentUser.uid).update({ username: nickname, wallet: address, lastSeen: firebase.database.ServerValue.TIMESTAMP });
            setIsLoading(false);
        } catch (err) { setError(err.message); setIsLoading(false); }
      };

      useEffect(() => {
        setTimeout(async () => {
            if (!(await authenticateFromSession())) setIsLoading(false);
        }, 1000);
      }, []);

      useEffect(() => {
        if (!user) return;
        const presenceRef = database.ref('presence/' + user.uid);
        database.ref('.info/connected').on('value', (snap) => {
          if (snap.val()) { presenceRef.onDisconnect().remove(); presenceRef.set({ online: true, username: user.nickname }); }
        });
        database.ref('presence').on('value', (snap) => {
           const data = snap.val();
           setOnlineUsers(data ? Object.values(data) : []);
        });
      }, [user]);

      useEffect(() => {
        if (!selectedChannel) return;
        const msgRef = database.ref('messages/' + selectedChannel.id).limitToLast(50);
        msgRef.on('value', (snap) => {
          const data = snap.val();
          setMessages(data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : []);
        });
        return () => msgRef.off();
      }, [selectedChannel]);

      useEffect(() => { dummyRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

      const handleSend = async () => {
        if (!inputText.trim() || !selectedChannel) return;
        await database.ref('messages/' + selectedChannel.id).push({
          content: inputText,
          username: user.nickname,
          userId: user.uid,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        setInputText("");
        setShowEmoji(false);
      };

      const handleLogout = async () => {
          await auth.signOut();
          if(window.web3Modal) await window.web3Modal.disconnect();
          sessionStorage.clear();
          window.location.href = 'index.html';
      };

      if (isLoading && !user) return <div className="h-screen w-full bg-gray-900 flex flex-col items-center justify-center text-white"><i className="fas fa-circle-notch fa-spin text-4xl text-purple-600 mb-4"></i><p>{statusMsg}</p></div>;

      if (!user) return (
        <div className="h-screen w-full bg-gray-900 flex flex-col items-center justify-center p-6 text-center">
            <img src="https://img1.wsimg.com/isteam/ip/ac9578cb-a6ce-417e-8ad5-b2d6701462eb/1000030902.png" className="w-24 h-24 rounded-2xl mb-4" />
            <h1 className="text-2xl font-bold text-white mb-6">MuzzSnap Login</h1>
            {error && <div className="bg-red-900/30 text-red-400 p-3 rounded-lg mb-4 text-xs border border-red-500/50">{error}</div>}
            <button onClick={connectAndLogin} className="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-8 rounded-full flex items-center gap-2 transition"><i className="fas fa-wallet"></i> Connect Wallet</button>
        </div>
      );

      return (
        <div className="flex h-screen bg-gray-900 text-gray-100 overflow-hidden relative">
            <div className={`fixed inset-y-0 left-0 z-50 w-64 bg-gray-800 border-r border-gray-700 transform transition-transform ${showSidebar ? 'translate-x-0' : '-translate-x-full'} lg:relative lg:translate-x-0 flex flex-col`}>
                <div className="h-16 flex items-center justify-between px-4 border-b border-gray-700 font-bold text-purple-400"><i className="fas fa-shield-alt mr-2"></i> MuzzSnap</div>
                <div className="p-4 overflow-y-auto flex-1">
                    <div className="text-xs font-bold text-gray-500 uppercase mb-2">Channels</div>
                    <div className="space-y-1 mb-6">
                        {FIXED_CHANNELS.map(ch => (
                            <button key={ch.id} onClick={() => { setSelectedChannel(ch); if(window.innerWidth < 1024) setShowSidebar(false); }}
                                className={`w-full text-left px-3 py-2 rounded text-sm flex items-center gap-2 ${selectedChannel?.id === ch.id ? 'bg-purple-600 text-white' : 'text-gray-400 hover:bg-gray-700'}`}>
                                # {ch.name}
                            </button>
                        ))}
                    </div>
                    <div className="text-xs font-bold text-gray-500 uppercase mb-2">Online ({onlineUsers.length})</div>
                    {onlineUsers.map((u, i) => <div key={i} className="text-sm text-gray-400 px-2 py-1 flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-green-500"></span>{u.username}</div>)}
                </div>
                <div className="p-4 bg-gray-900 border-t border-gray-700">
                    <div className="text-[10px] text-gray-500 truncate mb-2">{user.address}</div>
                    <button onClick={handleLogout} className="w-full py-2 bg-red-500/10 text-red-400 border border-red-500/20 rounded-lg text-xs hover:bg-red-500/20 transition">Disconnect</button>
                </div>
            </div>

            <div className="flex-1 flex flex-col bg-gray-900">
                <div className="h-16 border-b border-gray-700 flex items-center px-4 bg-gray-800/50">
                    <button onClick={() => setShowSidebar(true)} className="lg:hidden mr-4 text-gray-400"><i className="fas fa-bars"></i></button>
                    <div className="font-bold"># {selectedChannel?.name}</div>
                </div>
                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                    {messages.map(msg => (
                        <div key={msg.id} className={`flex ${msg.userId === user.uid ? 'justify-end' : 'justify-start'}`}>
                            <div className={`max-w-[80%] rounded-2xl px-4 py-2 text-sm ${msg.userId === user.uid ? 'bg-purple-600 text-white' : 'bg-gray-800 border border-gray-700 text-gray-200'}`}>
                                {msg.userId !== user.uid && <div className="text-[10px] text-purple-400 font-bold mb-1">{msg.username}</div>}
                                {msg.content}
                            </div>
                        </div>
                    ))}
                    <div ref={dummyRef}></div>
                </div>
                <div className="p-4 border-t border-gray-700">
                    <div className="flex items-center gap-2 bg-gray-800 rounded-xl px-4 py-2 border border-gray-700">
                        <input value={inputText} onChange={e => setInputText(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} className="flex-1 bg-transparent border-none focus:ring-0 text-white" placeholder={`Message #${selectedChannel?.name}`} />
                        <button onClick={handleSend} className="text-purple-500 hover:text-purple-400"><i className="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
      );
    }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
