<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MuzzSnap – 3D Web3 Chat</title>

<!-- React -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- UI -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@400;600;700&display=swap');

:root{
  --accent:#ff0000;
  --accent-glow:rgba(255,0,0,.6);
  --glass-bg:rgba(20,0,0,.45);
  --glass-border:rgba(255,0,0,.25);
}

*{margin:0;padding:0;box-sizing:border-box}
body{
  background:black;
  color:white;
  font-family:'Rajdhani',sans-serif;
  height:100vh;
  overflow:hidden;
}

/* Fondo */
.cyber-grid{
  position:fixed;inset:0;
  background:
    radial-gradient(circle at top,var(--accent-glow),transparent 55%),
    radial-gradient(circle at bottom,var(--accent-glow),transparent 55%);
  z-index:-1;
}

/* Drawer */
.drawer{
  position:fixed;
  inset-y:0;
  left:0;
  width:300px;
  background:var(--glass-bg);
  backdrop-filter:blur(25px);
  border-right:2px solid var(--accent);
  transform:translateX(-100%);
  transition:.3s;
  z-index:100;
}
.drawer.open{transform:translateX(0)}

.overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.75);
  backdrop-filter:blur(6px);
  opacity:0;
  pointer-events:none;
  transition:.3s;
  z-index:90;
}
.overlay.visible{
  opacity:1;
  pointer-events:auto;
}

/* ===== CHAT 3D ===== */
.chat-3d-stage{perspective:1200px}
.chat-3d-card{
  background:var(--glass-bg);
  backdrop-filter:blur(30px);
  border-radius:28px;
  border:1px solid var(--glass-border);
  transform-style:preserve-3d;
  box-shadow:
    0 40px 120px rgba(0,0,0,.85),
    inset 0 1px 0 rgba(255,255,255,.15),
    0 0 80px var(--accent-glow);
  transition:transform .2s ease;
}
.chat-3d-layer{transform:translateZ(35px)}

.message-bubble{
  padding:14px 20px;
  border-radius:18px;
  max-width:85%;
  transform-style:preserve-3d;
}
.message-bubble.me{
  background:linear-gradient(135deg,var(--accent),black);
  transform:translateZ(25px);
}
.message-bubble.other{
  background:rgba(40,40,40,.8);
  border:1px solid rgba(255,255,255,.1);
  transform:translateZ(15px);
}

.input-3d{
  background:var(--glass-bg);
  border:1px solid var(--glass-border);
  border-radius:18px;
  padding:14px 18px;
  color:white;
  width:100%;
}
.send-btn{
  width:56px;height:56px;
  border-radius:16px;
  background:linear-gradient(135deg,var(--accent),black);
  box-shadow:0 0 25px var(--accent-glow);
}

/* Mobile ajustes */
@media(max-width:768px){
  .chat-3d-card{border-radius:22px}
  .message-bubble{font-size:14px}
  .drawer{width:85%}
}
</style>
</head>

<body>
<div class="cyber-grid"></div>
<div id="root"></div>

<script type="text/babel">
const {useState,useEffect,useRef}=React;

/* Firebase */
firebase.initializeApp({
  apiKey:"AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
  authDomain:"pulsari.firebaseapp.com",
  databaseURL:"https://pulsari-default-rtdb.firebaseio.com",
  projectId:"pulsari"
});
const db=firebase.database();
const auth=firebase.auth();

function App(){
  const [user,setUser]=useState(null);
  const [drawer,setDrawer]=useState(false);
  const [messages,setMessages]=useState([]);
  const [text,setText]=useState("");
  const scrollRef=useRef();

  /* Login wallet obligatorio */
  const login=async()=>{
    if(!window.ethereum)return alert("MetaMask requerido");
    const accs=await window.ethereum.request({method:'eth_requestAccounts'});
    const wallet=accs[0].toLowerCase();
    const cred=await auth.signInAnonymously();
    const u={uid:cred.user.uid,name:"Anon_"+wallet.slice(-4),wallet};
    await db.ref("presence/"+u.uid).set(u);
    db.ref("presence/"+u.uid).onDisconnect().remove();
    setUser(u);
  };
  useEffect(()=>{login()},[]);

  useEffect(()=>{
    if(!user)return;
    db.ref("messages/general").limitToLast(50).on("value",s=>{
      const v=s.val()||{};
      setMessages(Object.keys(v).map(k=>({id:k,...v[k]})));
    });
  },[user]);

  useEffect(()=>{scrollRef.current?.scrollIntoView({behavior:"smooth"})},[messages]);

  /* Tilt solo desktop */
  useEffect(()=>{
    if(window.innerWidth<900)return;
    const card=document.querySelector(".chat-3d-card");
    if(!card)return;
    const move=e=>{
      const r=card.getBoundingClientRect();
      const x=(e.clientX-r.left)/r.width-.5;
      const y=(e.clientY-r.top)/r.height-.5;
      card.style.transform=`rotateY(${x*10}deg) rotateX(${-y*10}deg)`;
    };
    const reset=()=>card.style.transform="rotateX(0) rotateY(0)";
    card.addEventListener("mousemove",move);
    card.addEventListener("mouseleave",reset);
  },[user]);

  const send=async()=>{
    if(!text.trim())return;
    await db.ref("messages/general").push({content:text,uid:user.uid,time:Date.now()});
    setText("");
  };

  if(!user){
    return(
      <div className="h-screen flex items-center justify-center">
        <div className="text-center">
          <h1 className="text-4xl font-black">MUZZSNAP</h1>
          <p className="opacity-60 mt-4">Firmando wallet…</p>
        </div>
      </div>
    );
  }

  return(
    <>
      <div className={`overlay ${drawer?'visible':''}`} onClick={()=>setDrawer(false)}></div>

      <aside className={`drawer ${drawer?'open':''} p-6`}>
        <h2 className="font-black mb-6">Opciones</h2>
        <button className="w-full mb-3"># GENERAL</button>
        <button className="w-full"># ESPAÑOL</button>
      </aside>

      <header className="p-4 flex justify-between items-center">
        <button onClick={()=>setDrawer(true)}><i className="fas fa-bars"></i></button>
        <span className="font-black">MUZZSNAP</span>
      </header>

      <div className="chat-3d-stage flex-1 p-3">
        <div className="chat-3d-card h-full max-w-5xl mx-auto p-4">
          <div className="chat-3d-layer h-full overflow-y-auto space-y-4">
            {messages.map(m=>(
              <div key={m.id} className={m.uid===user.uid?"flex justify-end":"flex"}>
                <div className={"message-bubble "+(m.uid===user.uid?"me":"other")}>{m.content}</div>
              </div>
            ))}
            <div ref={scrollRef}></div>
          </div>
        </div>
      </div>

      <footer className="p-3 flex gap-3">
        <input className="input-3d" value={text}
          onChange={e=>setText(e.target.value)}
          onKeyDown={e=>e.key==="Enter"&&send()}
          placeholder="Transmitir…" />
        <button className="send-btn" onClick={send}>
          <i className="fas fa-bolt"></i>
        </button>
      </footer>
    </>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
