<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MuzzSnap – 3D Web3 Chat</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@400;600;700&display=swap');

:root{
  --accent:#ff0000;
  --accent-glow:rgba(255,0,0,.6);
  --glass-bg:rgba(20,0,0,.45);
  --glass-border:rgba(255,0,0,.25);
}

*{margin:0;padding:0;box-sizing:border-box}
body{
  background:black;
  color:white;
  font-family:'Rajdhani',sans-serif;
  height:100vh;
  overflow:hidden;
}

.cyber-grid{
  position:fixed;inset:0;
  background:
    radial-gradient(circle at top,var(--accent-glow),transparent 50%),
    radial-gradient(circle at bottom,var(--accent-glow),transparent 50%);
  z-index:-1;
}

.chat-3d-stage{ perspective:1400px; }
.chat-3d-card{
  background:var(--glass-bg);
  backdrop-filter:blur(30px) saturate(180%);
  border-radius:30px;
  border:1px solid var(--glass-border);
  transform-style:preserve-3d;
  box-shadow: 0 40px 120px rgba(0,0,0,.9), 0 0 90px var(--accent-glow);
  transition:transform .2s ease;
  position:relative;
}
.chat-3d-layer{transform:translateZ(45px)}

.message-bubble{
  padding:14px 20px;
  border-radius:18px;
  max-width:75%;
  transform-style:preserve-3d;
  animation:pop .3s ease;
}
@keyframes pop{
  from{opacity:0;transform:scale(.8) translateY(10px)}
  to{opacity:1;transform:scale(1)}
}
.message-bubble.me{ background:linear-gradient(135deg,var(--accent),black); transform:translateZ(30px); }
.message-bubble.other{ background:rgba(40,40,40,.8); border:1px solid rgba(255,255,255,.1); transform:translateZ(18px); }

.input-3d{
  background:var(--glass-bg);
  border:1px solid var(--glass-border);
  border-radius:20px;
  padding:16px;
  color:white;
  width:100%;
}

.send-btn{
  width:60px;height:60px;
  border-radius:18px;
  background:linear-gradient(135deg,var(--accent),black);
  color:white;font-size:22px;
  box-shadow:0 0 25px var(--accent-glow);
}

.logout-btn {
  transition: all 0.3s ease;
  border: 1px solid rgba(255,0,0,0.3);
}
.logout-btn:hover {
  background: rgba(255,0,0,0.2);
  border-color: #ff0000;
  text-shadow: 0 0 10px #ff0000;
}
</style>
</head>

<body>
<div class="cyber-grid"></div>
<div id="root"></div>

<script type="text/babel">
const {useState,useEffect,useRef}=React;

firebase.initializeApp({
  apiKey:"AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
  authDomain:"pulsari.firebaseapp.com",
  databaseURL:"https://pulsari-default-rtdb.firebaseio.com",
  projectId:"pulsari"
});
const db=firebase.database();
const auth=firebase.auth();

function App(){
  const [user,setUser]=useState(null);
  const [text,setText]=useState("");
  const [messages,setMessages]=useState([]);
  const [error, setError] = useState("Verificando autorización...");
  const scrollRef=useRef();

  const validateAccess = async () => {
    try {
      const savedWallet = sessionStorage.getItem('muzz_wallet');
      const savedSig = sessionStorage.getItem('muzz_sig');

      if (!savedWallet || !savedSig) {
        window.location.href = 'index.html';
        return;
      }

      const cred = await auth.signInAnonymously();
      const u = {
        uid: cred.user.uid,
        name: "User_" + savedWallet.slice(-4),
        wallet: savedWallet
      };

      await db.ref("presence/" + u.uid).set(u);
      db.ref("presence/" + u.uid).onDisconnect().remove();
      
      setUser(u);
      setError(null);
    } catch (err) {
      setError("Error de autenticación. Regresando...");
      setTimeout(() => window.location.href = 'index.html', 2000);
    }
  };

  useEffect(() => { validateAccess(); }, []);

  useEffect(() => {
    if(!user) return;
    const msgRef = db.ref("messages/general").limitToLast(50);
    msgRef.on("value", s => {
      const v = s.val() || {};
      setMessages(Object.keys(v).map(k => ({ id: k, ...v[k] })));
    });
    return () => msgRef.off();
  }, [user]);

  useEffect(() => { scrollRef.current?.scrollIntoView({ behavior: "smooth" }) }, [messages]);

  const handleLogout = () => {
    sessionStorage.clear(); // Borra firma y wallet
    window.location.href = 'index.html';
  };

  const send = async () => {
    if (!text.trim() || !user) return;
    await db.ref("messages/general").push({
      content: text,
      uid: user.uid,
      wallet: user.wallet,
      time: Date.now()
    });
    setText("");
  };

  if (error) {
    return (
      <div className="h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin mb-4"><i className="fas fa-circle-notch text-3xl text-red-600"></i></div>
          <h1 className="text-xl font-bold">{error}</h1>
        </div>
      </div>
    );
  }

  return (
    <div className="h-screen flex flex-col chat-3d-stage p-4 md:p-8">
      {/* Header con Logout */}
      <div className="flex justify-between items-center max-w-5xl mx-auto w-full mb-4 px-2">
        <div className="flex items-center gap-3">
            <span className="text-[10px] tracking-[0.2em] uppercase opacity-50 font-bold">MuzzSnap Secure</span>
            <div className="h-1 w-1 rounded-full bg-green-500 animate-pulse"></div>
        </div>
        
        <div className="flex items-center gap-4">
            <span className="hidden md:inline text-[10px] font-mono opacity-40">{user.wallet}</span>
            <button 
                onClick={handleLogout}
                className="logout-btn px-4 py-1 rounded-full text-[10px] uppercase font-bold text-red-500 bg-red-500/5 border border-red-500/20"
            >
                <i className="fas fa-power-off mr-2"></i>Cerrar Sesión
            </button>
        </div>
      </div>

      <div className="chat-3d-card flex-1 p-4 md:p-6 max-w-5xl mx-auto w-full overflow-hidden flex flex-col">
        <div className="chat-3d-layer space-y-4 overflow-y-auto pr-2 custom-scrollbar flex-1">
          {messages.map(m => (
            <div key={m.id} className={m.uid === user.uid ? "flex justify-end" : "flex"}>
              <div className={"message-bubble " + (m.uid === user.uid ? "me" : "other")}>
                <p className="text-sm md:text-base">{m.content}</p>
                <span className="text-[9px] opacity-40 block mt-1">
                  {new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </span>
              </div>
            </div>
          ))}
          <div ref={scrollRef}></div>
        </div>
      </div>

      <div className="flex gap-3 max-w-5xl mx-auto w-full mt-6">
        <input className="input-3d focus:outline-none focus:border-red-500 transition-all"
          value={text}
          onChange={e => setText(e.target.value)}
          onKeyDown={e => e.key === "Enter" && send()}
          placeholder="Escribe un mensaje..."
        />
        <button onClick={send} className="send-btn hover:scale-105 active:scale-95 transition-transform">
          <i className="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
