<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MuzzSnap</title>

  <!-- LIBS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Fira+Code&display=swap');
    body { background:#050505; color:white; margin:0; height:100vh }
    .panel-main { background:#0c0c0c; border:1px solid rgba(255,0,0,.2); border-radius:20px }
    .bubble { padding:10px 15px; border-radius:16px; max-width:80% }
    .bubble.me { background:#ff0000; margin-left:auto }
    .bubble.other { background:#1a1a1a; border:1px solid rgba(255,255,255,.05) }
    .custom-scroll::-webkit-scrollbar { width:4px }
    .custom-scroll::-webkit-scrollbar-thumb { background:#ff0000 }
    .font-orbitron { font-family:'Orbitron',sans-serif }
    .hacker-font { font-family:'Fira Code',monospace }
  </style>
</head>

<body>
<div id="root" class="h-full"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

const firebaseConfig = {
  apiKey: atob('QUl6YVN5QWUxLUpmTmRlME5LSU1kRTdwaGZFWGxtOUphcVVIMGpZ'),
  databaseURL: atob('aHR0cHM6Ly9wdWxzYXJpLWRlZmF1bHQtcnRkYi5maXJlYmFzZWlvLmNvbQ=='),
  projectId: atob('cHVsc2FyaQ==')
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
firebase.auth().signInAnonymously();
const db = firebase.database();

function App() {
  const [user, setUser] = useState(null);
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState("");
  const endRef = useRef();

  useEffect(() => {
    const addr = sessionStorage.getItem("muzz_wallet_address");
    if (!addr) location.href="login.html";
    setUser({ addr, name:`ğŸ§¬ Node_${addr.slice(-4)}` });
  }, []);

  useEffect(() => {
    if (!user) return;
    const ref = db.ref("messages/general").limitToLast(100);
    ref.on("value", s => {
      const v = s.val();
      if (v) setMessages(Object.values(v));
    });
    return () => ref.off();
  }, [user]);

  useEffect(()=>endRef.current?.scrollIntoView({behavior:"smooth"}),[messages]);

  const send = () => {
    if (!input.trim()) return;
    db.ref("messages/general").push({
      sender:user.addr,
      username:user.name,
      content:input,
      timestamp:Date.now()
    });
    setInput("");
  };

  if (!user) return <div className="h-screen flex items-center justify-center text-red-600 animate-pulse">ğŸ” Enlazando nodoâ€¦</div>;

  return (
    <div className="flex h-screen p-4 gap-6 bg-black">

      {/* MENU */}
      <aside className="hidden lg:flex w-64 panel-main p-6 flex-col">
        <h1 className="font-orbitron text-red-600 font-black text-xl mb-8">ğŸš€ MUZZSNAP</h1>

        <button className="p-3 mb-2 rounded-xl bg-red-600/10 text-red-500 font-bold">
          ğŸ’¬ # General
        </button>

        <button className="p-3 mb-2 rounded-xl hover:bg-white/5 text-gray-400">
          ğŸ“¡ Nodes
        </button>

        <button className="p-3 mb-2 rounded-xl hover:bg-white/5 text-gray-400">
          ğŸ§  AI
        </button>

        <button onClick={()=>{sessionStorage.clear();location.reload()}}
          className="mt-auto p-3 text-xs text-red-800 border border-red-900/30 rounded-xl">
          âŒ Cerrar Nodo
        </button>
      </aside>

      {/* CHAT */}
      <main className="flex-1 panel-main flex flex-col overflow-hidden">
        <header className="p-4 border-b border-white/5 flex justify-between">
          <span className="text-red-600 font-orbitron font-bold">ğŸŸ¢ /general</span>
          <span className="text-xs hacker-font text-gray-500">{user.addr.slice(0,10)}â€¦</span>
        </header>

        <div className="flex-1 overflow-y-auto p-6 custom-scroll">
          {messages.map((m,i)=>(
            <div key={i} className={`mb-4 ${m.sender===user.addr?'text-right':''}`}>
              <div className={`bubble ${m.sender===user.addr?'me':'other'}`}>{m.content}</div>
            </div>
          ))}
          <div ref={endRef}/>
        </div>

        <div className="p-4 border-t border-white/5 flex gap-2">
          <input className="flex-1 bg-black/50 border border-white/10 rounded-xl px-4 text-red-500 hacker-font"
            value={input}
            onChange={e=>setInput(e.target.value)}
            onKeyDown={e=>e.key==="Enter"&&send()}
            placeholder="ğŸ’¬ Escribe algoâ€¦" />
          <button onClick={send} className="bg-red-600 px-4 rounded-xl">ğŸš€</button>
        </div>
      </main>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById("root"));
</script>
</body>
</html>
