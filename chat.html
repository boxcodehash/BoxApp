<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MuzzSnap - Auditada & Estable</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Orbitron:wght@400;900&display=swap');
    body { background: #050505; color: white; font-family: sans-serif; height: 100vh; margin: 0; }
    .panel-main { background: #0c0c0c; border: 1px solid rgba(255,0,0,0.1); border-radius: 20px; height: 100%; }
    .bubble { padding: 10px 15px; border-radius: 15px; font-size: 14px; margin-bottom: 5px; max-width: 80%; word-wrap: break-word; }
    .bubble.me { background: #ff0000; margin-left: auto; border-bottom-right-radius: 2px; color: white; }
    .bubble.other { background: #1a1a1a; margin-right: auto; border-bottom-left-radius: 2px; border: 1px solid rgba(255,255,255,0.05); }
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #ff0000; border-radius: 10px; }
    .hacker-font { font-family: 'Fira Code', monospace; }
  </style>
</head>
<body>
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- CONFIGURACIÓN PERMANENTE ---
    const MUZZLE_CONTRACT = "0xef3dAa5fDa8Ad7aabFF4658f1F78061fd626B8f0";
    const VIP_WALLET = "0xBEec8F1fee64627F83F0188eAe621F367A6bCb8a".toLowerCase();
    const MIN_REQUIRED = 1000000n * (10n ** 18n); 
    const ABI_BAL = [{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];

    const firebaseConfig = {
      apiKey: atob('QUl6YVN5QWUxLUpmTmRlME5LSU1kRTdwaGZFWGxtOUphcVVIMGpZ'),
      databaseURL: atob('aHR0cHM6Ly9wdWxzYXJpLWRlZmF1bHQtcnRkYi5maXJlYmFzZWlvLmNvbQ=='),
      projectId: atob('cHVsc2FyaQ==')
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function App() {
      const [user, setUser] = useState(null);
      const [messages, setMessages] = useState([]);
      const [inputValue, setInputValue] = useState("");
      const [isPrivateReady, setIsPrivateReady] = useState(false);
      const scrollRef = useRef();

      useEffect(() => {
        const storedAddr = sessionStorage.getItem('muzz_wallet_address');
        
        if (!storedAddr) {
          window.location.href = 'login.html';
          return;
        }

        const name = storedAddr.startsWith('0x') ? `Node_${storedAddr.slice(-4)}` : storedAddr;
        setUser({ name: name, addr: storedAddr });

        // Conexión anónima a Firebase
        firebase.auth().signInAnonymously().catch(e => console.error("Firebase Auth Error"));

        // Lógica de Auditoría de Wallet (No bloqueante)
        const verifyAccess = async () => {
          if (storedAddr.toLowerCase() === VIP_WALLET) {
            setIsPrivateReady(true);
            return;
          }

          if (typeof window.ethereum !== 'undefined') {
            try {
              const provider = new ethers.BrowserProvider(window.ethereum);
              const contract = new ethers.Contract(MUZZLE_CONTRACT, ABI_BAL, provider);
              const balance = await contract.balanceOf(storedAddr);
              if (balance >= MIN_REQUIRED) {
                setIsPrivateReady(true);
              }
            } catch (err) {
              console.warn("Wallet verification failed, but chat will continue.");
            }
          }
        };
        verifyAccess();
      }, []);

      useEffect(() => {
        if (!user) return;
        const chatRef = db.ref('messages/general').limitToLast(50);
        chatRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            setMessages(Object.values(data));
          }
        });
        return () => chatRef.off();
      }, [user]);

      useEffect(() => {
        if (scrollRef.current) {
          scrollRef.current.scrollIntoView({ behavior: 'smooth' });
        }
      }, [messages]);

      const handleSendMessage = () => {
        if (!inputValue.trim() || !user) return;
        db.ref('messages/general').push({
          content: inputValue,
          username: user.name,
          sender: user.addr,
          timestamp: Date.now()
        });
        setInputValue("");
      };

      if (!user) return (
        <div className="h-screen bg-black flex items-center justify-center">
          <div className="text-red-600 font-orbitron animate-pulse uppercase tracking-[0.3em]">
            Iniciando Enlace Seguro...
          </div>
        </div>
      );

      return (
        <div className="flex h-screen p-4 md:p-6 gap-6 bg-black">
          {/* BARRA LATERAL */}
          <aside className="w-64 panel-main p-6 hidden lg:flex flex-col border-red-600/20">
            <h1 className="font-orbitron font-black text-xl text-red-600 mb-10 tracking-tighter italic">MUZZSNAP</h1>
            
            <div className="flex-1">
              <p className="text-[10px] text-gray-600 font-bold uppercase tracking-widest mb-4">Red Pública</p>
              <button className="w-full text-left p-3 rounded-xl bg-red-600/10 text-red-600 font-bold text-xs mb-2 border-l-4 border-red-600">
                # GENERAL
              </button>

              {isPrivateReady && (
                <div className="mt-8 pt-8 border-t border-white/5">
                  <p className="text-[10px] text-red-500 font-bold uppercase tracking-widest mb-4">Canal Encriptado</p>
                  <a href="private.html" className="flex items-center justify-center w-full py-4 bg-red-600 hover:bg-red-700 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all shadow-lg shadow-red-600/20">
                    <i className="fas fa-user-secret mr-2"></i> Private
                  </a>
                </div>
              )}
            </div>

            <button 
              onClick={() => { sessionStorage.clear(); window.location.reload(); }}
              className="mt-auto py-3 border border-red-900/30 text-red-900 text-[10px] font-bold rounded-xl uppercase hover:bg-red-600/5"
            >
              Cerrar Nodo
            </button>
          </aside>

          {/* AREA DE CHAT */}
          <main className="flex-1 panel-main flex flex-col overflow-hidden border-white/5 shadow-2xl">
            <header className="h-16 flex items-center justify-between px-8 border-b border-white/5 bg-white/5">
              <div className="flex items-center gap-2">
                <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                <span className="text-xs font-black text-red-600 uppercase italic">/ general</span>
              </div>
              <span className="text-[10px] text-gray-600 hacker-font uppercase">{user.addr.slice(0,12)}...</span>
            </header>

            <div className="flex-1 overflow-y-auto p-4 md:p-8 flex flex-col custom-scroll">
              {messages.map((m, idx) => (
                <div key={idx} className={`flex flex-col ${m.sender === user.addr ? 'items-end' : 'items-start'} mb-6`}>
                  <span className="text-[9px] text-gray-600 font-bold uppercase mb-1.5 px-2">{m.username}</span>
                  <div className={`bubble shadow-lg ${m.sender === user.addr ? 'me' : 'other'}`}>
                    {m.content}
                  </div>
                </div>
              ))}
              <div ref={scrollRef}></div>
            </div>

            {/* ENTRADA DE TEXTO */}
            <div className="p-4 md:p-6 bg-black/40 border-t border-white/5">
              <div className="flex items-center bg-black/50 border border-white/10 rounded-2xl p-2 pl-6 focus-within:border-red-600/50 transition-all">
                <input 
                  value={inputValue}
                  onChange={(e) => setInputValue(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handleSendMessage()}
                  placeholder="Escribe un mensaje..."
                  className="flex-1 bg-transparent border-none focus:ring-0 text-sm hacker-font text-red-500"
                />
                <button 
                  onClick={handleSendMessage}
                  className="w-12 h-12 bg-red-600 hover:bg-red-500 rounded-xl flex items-center justify-center transition-all shadow-lg"
                >
                  <i className="fas fa-paper-plane text-white text-xs"></i>
                </button>
              </div>
            </div>
          </main>
        </div>
      );
    }

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
  </script>
</body>
</html>
