<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MuzzSnap | Social Node</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <script src="muzz-core.js"></script>

    <style>
        :root { --bg: #000; --border: #2f3336; --accent: #ff0000; }
        body { background: var(--bg); color: #e7e9ea; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .feed-container { border-left: 1px solid var(--border); border-right: 1px solid var(--border); min-height: 100vh; max-width: 600px; margin: 0 auto; }
        textarea::placeholder { color: #71767b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [posts, setPosts] = useState([]);
            const [text, setText] = useState("");
            const [userAddr, setUserAddr] = useState("0x0000");

            useEffect(() => {
                const addr = sessionStorage.getItem('muzz_wallet_address') || "Guest";
                setUserAddr(addr);

                // Llamada a funciones dentro de muzz-core.js
                setPosts(window.loadFromVault());
                
                window.syncBridge((newPost) => {
                    setPosts(prev => {
                        if (prev.find(p => p.id === newPost.id)) return prev;
                        const updated = [newPost, ...prev].slice(0, 50);
                        window.saveToVault(updated);
                        return updated;
                    });
                });
            }, []);

            const handleSend = () => {
                if(!text.trim()) return;
                // Usamos la referencia a database que está en muzz-core.js
                database.ref('p2p_relay').push({
                    id: "m_" + Date.now(),
                    content: text,
                    username: "Node_" + userAddr.slice(-4),
                    address: userAddr,
                    timestamp: Date.now()
                });
                setText("");
            };

            return (
                <div className="feed-container flex flex-col">
                    <header className="p-4 sticky top-0 bg-black/80 backdrop-blur-md border-b border-[#2f3336] z-10 flex justify-between items-center">
                        <span className="font-bold text-xl">MuzzSnap</span>
                        <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    </header>

                    <div className="p-4 border-b border-[#2f3336] flex gap-4">
                        <div className="w-10 h-10 rounded-full bg-zinc-800 flex-shrink-0"></div>
                        <div className="flex-1">
                            <textarea 
                                value={text} onChange={e => setText(e.target.value)}
                                className="w-full bg-transparent border-none focus:ring-0 text-lg resize-none" 
                                placeholder="¿Qué transmites al lazo?"
                            />
                            <div className="flex justify-end mt-2">
                                <button onClick={handleSend} className="bg-red-600 px-5 py-1.5 rounded-full font-bold text-sm">Postear</button>
                            </div>
                        </div>
                    </div>

                    <div className="divide-y divide-[#2f3336]">
                        {posts.map(p => (
                            <article key={p.id} className="p-4 hover:bg-zinc-950 transition-colors">
                                <div className="flex gap-3">
                                    <div className="w-10 h-10 rounded-full bg-red-900/20 border border-red-900/30 flex items-center justify-center">
                                        <i className="fas fa-microchip text-red-600 text-xs"></i>
                                    </div>
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="font-bold text-sm">{p.username}</span>
                                            <span className="text-xs text-zinc-600">@{p.address.slice(-4)}</span>
                                        </div>
                                        <p className="text-[15px]">{p.content}</p>
                                    </div>
                                </div>
                            </article>
                        ))}
                    </div>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
