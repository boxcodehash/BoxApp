<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MuzzSnap – Private DM Edition</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
body{background:#050505;color:white}
.bubble-3d{padding:12px 16px;border-radius:16px;max-width:80%}
.bubble-3d.me{background:#ff0000;color:white;align-self:flex-end}
.bubble-3d.other{background:#1a1a1a}
.private-msg{color:#00aaff}
.online-indicator{width:8px;height:8px;background:#39ff14;border-radius:50%}
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const {useState,useEffect,useRef}=React;

const firebaseConfig={
  apiKey:"YOUR_API_KEY",
  authDomain:"YOUR_DOMAIN",
  databaseURL:"YOUR_DB_URL",
  projectId:"YOUR_PROJECT",
};

firebase.initializeApp(firebaseConfig);
const db=firebase.database();

function App(){

const [user,setUser]=useState(null);
const [online,setOnline]=useState([]);
const [messages,setMessages]=useState([]);
const [input,setInput]=useState("");

const [privateUser,setPrivateUser]=useState(null);
const [privateMessages,setPrivateMessages]=useState([]);
const [isPrivate,setIsPrivate]=useState(false);

const endRef=useRef(null);

useEffect(()=>{
  const wallet=sessionStorage.getItem("muzz_wallet_address");
  if(!wallet){location.href="login.html";return;}

  firebase.auth().signInAnonymously().then(res=>{
    const uid=res.user.uid;
    const username=wallet.startsWith("guest_")?wallet.replace("guest_",""):`Node_${wallet.slice(-4)}`;
    setUser({uid,username,wallet});

    db.ref("status/"+uid).set({uid,username});
    db.ref("status/"+uid).onDisconnect().remove();

    db.ref("status").on("value",s=>{
      setOnline(s.val()?Object.values(s.val()):[]);
    });
  });
},[]);

useEffect(()=>{
  db.ref("messages/general").limitToLast(50).on("value",snap=>{
    const v=snap.val();
    setMessages(v?Object.values(v):[]);
  });
},[]);

useEffect(()=>{
  if(!privateUser||!isPrivate)return;
  const id=[user.uid,privateUser.uid].sort().join("_");
  db.ref("privateMessages/"+id).limitToLast(50).on("value",s=>{
    const v=s.val();
    setPrivateMessages(v?Object.values(v):[]);
  });
},[privateUser,isPrivate]);

useEffect(()=>{endRef.current?.scrollIntoView({behavior:"smooth"})});

const send=()=>{
  if(!input.trim())return;

  if(isPrivate&&privateUser){
    const id=[user.uid,privateUser.uid].sort().join("_");
    db.ref("privateMessages/"+id).push({
      from:user.uid,
      to:privateUser.uid,
      content:input,
      timestamp:Date.now()
    });
    setInput("");
    return;
  }

  db.ref("messages/general").push({
    username:user.username,
    content:input,
    userId:user.uid,
    timestamp:Date.now()
  });
  setInput("");
};

const openDM=(u)=>{
  if(!u.username.startsWith("Node_"))return;
  setPrivateUser(u);
  setIsPrivate(true);
};

if(!user)return <div className="p-10">Connecting...</div>;

return(
<div className="flex h-screen">

<aside className="w-64 border-r border-white/10 p-4">
<h2 className="font-bold mb-4">Online</h2>
{online.map(o=>(
<div key={o.uid} className="flex gap-2 items-center cursor-pointer"
 onClick={()=>openDM(o)}>
<span className="online-indicator"></span>
<span className="hover:text-blue-400">{o.username}</span>
</div>
))}

{isPrivate&&(
<button className="mt-4 w-full bg-blue-600/20 text-blue-400 p-2 rounded"
onClick={()=>{setIsPrivate(false);setPrivateUser(null);}}>
← Back to Public
</button>
)}
</aside>

<main className="flex-1 flex flex-col">
<div className="flex-1 overflow-y-auto p-4 flex flex-col gap-3">

{!isPrivate&&messages.map((m,i)=>(
<div key={i}
 className={`bubble-3d ${m.userId===user.uid?'me':'other'}`}>
{m.content}
</div>
))}

{isPrivate&&privateMessages.map((m,i)=>(
<div key={i}
 className={`bubble-3d private-msg ${m.from===user.uid?'me':'other'}`}>
{m.content}
</div>
))}

<div ref={endRef}></div>
</div>

<div className="p-4 border-t border-white/10 flex gap-2">
<input className="flex-1 bg-black border p-2"
value={input}
onChange={e=>setInput(e.target.value)}
onKeyDown={e=>e.key==="Enter"&&send()}
placeholder={isPrivate?"Private message...":"Public message..."} />
<button onClick={send}
className="bg-red-600 px-4 rounded">Send</button>
</div>

</main>
</div>
);
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
