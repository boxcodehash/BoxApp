<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MuzzSnap - Secure Identity</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Orbitron:wght@400;900&display=swap');
    :root{--muzz-red:#ff0000}
    body{background:#050505;color:white;font-family:'Inter',sans-serif;height:100vh;overflow:hidden}
    .panel-3d{background:#0c0c0c;border:1px solid rgba(255,0,0,0.15);border-radius:24px;box-shadow:0 10px 30px rgba(0,0,0,0.8)}
    .hacker-input{font-family:'Fira Code',monospace;color:#39ff14!important}
    .bubble-3d{padding:12px 16px;border-radius:20px;font-size:14px;max-width:85%}
    .bubble-3d.me{background:linear-gradient(145deg,#ff0000,#b30000);color:white;align-self:flex-end}
    .bubble-3d.other{background:#1a1a1a;border:1px solid rgba(255,255,255,0.05)}
    .custom-scroll::-webkit-scrollbar{width:4px}
    .custom-scroll::-webkit-scrollbar-thumb{background:var(--muzz-red);border-radius:10px}
  </style>
</head>
<body>
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const {useState, useEffect, useRef} = React;

    // ConfiguraciÃ³n Firebase
    const fbConf = {
      apiKey: atob('QUl6YVN5QWUxLUpmTmRlME5LSU1kRTdwaGZFWGxtOUphcVVIMGpZ'),
      authDomain: atob('cHVsc2FyaS5maXJlYmFzZWFwcC5jb20='),
      databaseURL: atob('aHR0cHM6Ly9wdWxzYXJpLWRlZmF1bHQtcnRkYi5maXJlYmFzZWlvLmNvbQ=='),
      projectId: atob('cHVsc2FyaQ=='),
      appId: atob('MTo4MjQzMDYzMjEyMzM6d2ViOjJjOWJmYTAyMTcwYTE3ZDU2MGI1NzA=')
    };

    if (!firebase.apps.length) firebase.initializeApp(fbConf);
    const db = firebase.database();

    function App() {
      const [user, setUser] = useState(null);
      const [messages, setMessages] = useState([]);
      const [onlineUsers, setOnlineUsers] = useState([]);
      const [input, setInput] = useState("");
      const [targetUser, setTargetUser] = useState(null);
      
      const [authStep, setAuthStep] = useState("loading"); 
      const [regName, setRegName] = useState("");
      const [regPin, setRegPin] = useState("");
      const [errorMsg, setErrorMsg] = useState("");

      const scrollRef = useRef(null);

      useEffect(() => {
        const wallet = sessionStorage.getItem('muzz_wallet_address');
        
        firebase.auth().signInAnonymously().then(async (cred) => {
          const uid = cred.user.uid;

          // Si viene de Wallet, omitimos el registro de PIN
          if (wallet && !wallet.startsWith('guest_')) {
            const userData = { 
                username: `Node_${wallet.slice(-4)}`, 
                uid: uid, 
                type: 'wallet' 
            };
            completeLogin(userData);
          } else {
            setAuthStep("auth_screen");
          }
        });
      }, []);

      const completeLogin = (userData) => {
        setUser(userData);
        setAuthStep("chat");
        db.ref(`status/${userData.uid}`).onDisconnect().remove();
        db.ref(`status/${userData.uid}`).set(userData);
        db.ref('status').on('value', s => setOnlineUsers(s.val() ? Object.values(s.val()) : []));
      };

      const handleAuth = async () => {
        setErrorMsg("");
        const nameKey = regName.trim().toLowerCase();
        
        if (nameKey.length < 3) { setErrorMsg("NAME TOO SHORT"); return; }
        if (regPin.length !== 4) { setErrorMsg("PIN MUST BE 4 CHARACTERS"); return; }

        const userRef = db.ref(`accounts/${nameKey}`);
        const snap = await userRef.once('value');

        if (snap.exists()) {
          // El usuario existe, intentamos Login
          const existingUser = snap.val();
          if (existingUser.pin === regPin) {
            completeLogin(existingUser);
          } else {
            // Si el nombre existe pero el PIN no coincide
            setErrorMsg("USERNAME NOT AVAILABLE"); 
          }
        } else {
          // El usuario no existe, creamos Registro Nuevo
          const uid = firebase.auth().currentUser.uid;
          const newUserData = {
            username: regName.trim(),
            pin: regPin,
            uid: uid,
            type: 'manual',
            timestamp: Date.now()
          };
          await userRef.set(newUserData);
          completeLogin(newUserData);
        }
      };

      // Cifrado AES para DMs
      const getSecretKey = (pId) => [user.uid, pId].sort().join('_secret_');
      const encrypt = (t, pId) => CryptoJS.AES.encrypt(t, getSecretKey(pId)).toString();
      const decrypt = (c, pId) => {
        try {
          const b = CryptoJS.AES.decrypt(c, getSecretKey(pId));
          return b.toString(CryptoJS.enc.Utf8) || "ðŸ”’ Encrypted";
        } catch(e) { return "âŒ Error"; }
      };

      useEffect(() => {
        if (authStep !== "chat") return;
        const path = targetUser ? `pms/${[user.uid, targetUser.uid].sort().join('_')}` : `messages/general`;
        const mRef = db.ref(path).limitToLast(30);
        mRef.on('value', s => {
          const d = s.val();
          setMessages(d ? Object.keys(d).map(k => ({id:k, ...d[k]})) : []);
        });
        return () => mRef.off();
      }, [authStep, targetUser]);

      useEffect(() => { scrollRef.current?.scrollIntoView({behavior:'smooth'}); }, [messages]);

      // Pantalla de AutenticaciÃ³n (User + PIN)
      if (authStep === "auth_screen") {
        return (
          <div className="h-full flex items-center justify-center p-6 bg-black">
            <div className="panel-3d p-8 w-full max-w-md text-center">
              <h2 className="font-orbitron text-red-600 text-2xl mb-2 italic">TERMINAL LOGIN</h2>
              <p className="text-gray-500 text-[10px] mb-8 tracking-[0.3em]">SECURE ACCESS PROTOCOL</p>
              
              <div className="space-y-4">
                <div className="text-left">
                  <label className="text-[10px] text-red-500 font-bold ml-2">USER_ID</label>
                  <input value={regName} onChange={e => setRegName(e.target.value.replace(/[^a-zA-Z0-9]/g,""))} placeholder="Satoshi" className="w-full bg-black border border-white/10 p-4 rounded-xl hacker-input focus:border-red-600 outline-none" />
                </div>
                
                <div className="text-left">
                  <label className="text-[10px] text-red-500 font-bold ml-2">4-CHAR PIN (LETTERS/NUMBERS)</label>
                  <input maxLength="4" value={regPin} onChange={e => setRegPin(e.target.value)} placeholder="X7R2" className="w-full bg-black border border-white/10 p-4 rounded-xl hacker-input focus:border-red-600 outline-none text-center tracking-[1em]" />
                </div>

                {errorMsg && <p className="text-red-500 text-xs font-bold animate-pulse uppercase">{errorMsg}</p>}

                <button onClick={handleAuth} className="w-full bg-red-600 py-4 rounded-xl text-white font-black font-orbitron hover:bg-red-500 transition-all shadow-[0_0_20px_rgba(255,0,0,0.3)]">ACCESS SYSTEM</button>
              </div>
            </div>
          </div>
        );
      }

      // Chat Principal
      if (authStep === "chat") {
        return (
          <div className="flex h-screen p-0 md:p-6 gap-6 max-w-[1600px] mx-auto">
            <aside className="hidden lg:flex w-72 panel-3d p-6 flex-col">
              <h1 className="font-orbitron font-black text-xl mb-8">MUZZ<span className="text-red-600">SNAP</span></h1>
              <div className="flex-1 overflow-y-auto custom-scroll">
                <p className="text-[10px] text-gray-500 font-bold mb-4 uppercase">Online Users</p>
                {onlineUsers.filter(u => u.uid !== user.uid).map(u => (
                  <div key={u.uid} onClick={() => setTargetUser(u)} className={`p-3 rounded-xl cursor-pointer mb-2 flex items-center gap-3 ${targetUser?.uid === u.uid ? 'bg-red-600/20 border border-red-600/30' : 'hover:bg-white/5'}`}>
                    <div className="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_#22c55e]"></div>
                    <span className="text-xs font-bold uppercase">{u.username}</span>
                  </div>
                ))}
              </div>
            </aside>

            <main className="flex-1 panel-3d flex flex-col overflow-hidden relative">
              <header className="h-16 flex items-center justify-between px-8 border-b border-white/5 bg-white/5">
                <span className="text-red-600 font-black text-sm tracking-widest uppercase">
                  {targetUser ? `PRIVATE: ${targetUser.username}` : "/ PUBLIC_STATION"}
                </span>
                {targetUser && <button onClick={() => setTargetUser(null)} className="text-[10px] text-gray-500">EXIT_DM</button>}
              </header>

              <div className="flex-1 overflow-y-auto p-6 flex flex-col gap-4 custom-scroll">
                {messages.map(m => (
                  <div key={m.id} className={`flex flex-col ${m.userId === user.uid ? 'items-end' : 'items-start'}`}>
                    <span className="text-[9px] text-gray-600 mb-1">{m.username} {m.encrypted && "ðŸ”’"}</span>
                    <div className={`bubble-3d ${m.userId === user.uid ? 'me' : 'other'}`}>
                      {m.encrypted ? decrypt(m.content, (m.userId === user.uid ? targetUser?.uid : m.userId)) : m.content}
                    </div>
                  </div>
                ))}
                <div ref={scrollRef}></div>
              </div>

              <div className="p-6 bg-black">
                <div className="flex items-center bg-white/5 border border-white/10 rounded-2xl p-2 pl-4">
                  <input 
                    value={input} 
                    onChange={e => setInput(e.target.value)} 
                    onKeyDown={e => e.key === 'Enter' && (()=>{
                      const path = targetUser ? `pms/${[user.uid, targetUser.uid].sort().join('_')}` : `messages/general`;
                      db.ref(path).push({
                        content: targetUser ? encrypt(input, targetUser.uid) : input,
                        username: user.username,
                        userId: user.uid,
                        timestamp: Date.now(),
                        encrypted: !!targetUser
                      });
                      setInput("");
                    })()}
                    placeholder="Type message..." 
                    className="flex-1 bg-transparent border-none focus:ring-0 text-sm hacker-input" 
                  />
                  <button onClick={() => {}} className="w-12 h-12 bg-red-600 rounded-xl flex items-center justify-center"><i className="fas fa-paper-plane text-white"></i></button>
                </div>
              </div>
            </main>
          </div>
        );
      }
      return null;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
